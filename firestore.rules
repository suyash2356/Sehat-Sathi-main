rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check ownership
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check admin role
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.isAdmin == true || 
        request.auth.token.email == 'admin@sehatsathi.com'
      );
    }

    // Users collection (Patients/General Users)
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      match /{subcollection}/{docId} {
        allow read, write, delete: if isOwner(userId);
      }
    }

    // Doctors collection
    match /doctors/{doctorId} {
      // Anyone can read doctors (needed for the map/listing)
      allow read: if true; 
      
      // Update: Owner can update profile, Admin can verify/reject (delete)
      allow write: if isOwner(doctorId) || isAdmin();
      
      match /{subcollection}/{docId} {
         allow read, write, delete: if isOwner(doctorId) || isAdmin();
      }
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      // Create: Only the patient themselves can create an appointment request with their UID
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      
      // Read: Users can only read appointments they are part of
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.patientId || 
        request.auth.uid == resource.data.doctorId ||
        isAdmin()
      );

      // Update: Users can update appointments they are part of (e.g., status changes)
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.patientId || 
        request.auth.uid == resource.data.doctorId ||
        isAdmin()
      );
    }

    // Video calls (Signaling)
    match /calls/{callId} {
      // Only the initiator (patient) or the doctor for this specific appointment can create/access
      // We assume the callId is the same as appointmentId for simple linkage
      function isCallParticipant() {
        let appointment = get(/databases/$(database)/documents/appointments/$(callId)).data;
        return isAuthenticated() && (request.auth.uid == appointment.patientId || request.auth.uid == appointment.doctorId);
      }

      allow create: if isAuthenticated(); // First joiner creates
      allow read, update: if isCallParticipant();
      
      // Subcollections (Candidates)
      match /{allSubcollections=**} {
        allow read, write: if isCallParticipant();
      }
    // Reviews collection
    match /reviews/{reviewId} {
      // Create: Only the patient who had the appointment can review
      // We check that the requester matches the patientId in the review data
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      
      // Read: Publicly readable so other patients can see ratings
      allow read: if true;
    }

    // Prescriptions collection
    match /prescriptions/{prescriptionId} {
      // Public GET for QR code verification
      allow get: if true;
      
      // List restricted to participants
      allow list: if isAuthenticated() && (
        request.auth.uid == resource.data.patientId || 
        request.auth.uid == resource.data.doctorId ||
        isAdmin()
      );
      
      // Create: Only authenticated users (Doctors)
      allow create: if isAuthenticated();
      
      // Delete: Participant or Admin (for 24h cleanup)
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.patientId || 
        request.auth.uid == resource.data.doctorId ||
        isAdmin()
      );
    }

    // Default: Deny everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
